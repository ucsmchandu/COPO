{% extends "base.html" %}
{% load static %}
{% block title %}CO-PO Mapping{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'styles.css' %}">

<!-- Hero Section with Animation -->
<section class="hero-section py-1 mb-1" style="margin-top: 40px; background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%); border-radius: 0 0 50px 50px; box-shadow: 0 4px 24px rgba(67,206,162,0.10);" data-aos="fade-down">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center">
                <h1 class="display-4 fw-bold mb-3"
                    style="background: linear-gradient(90deg, #fff 10%, #43cea2 60%, #4e98e2 100%);
                           -webkit-background-clip: text;
                           -webkit-text-fill-color: transparent;
                           background-clip: text;">
                    <i class="bi bi-diagram-3 me-3"></i>
                    CO-PO Mapping
                </h1>
            </div>
        </div>
    </div>
</section>

<div class="container-fluid">
    <!-- Centered Course Selection Card -->
    <div class="row justify-content-center mb-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-lg rounded-4" data-aos="fade-down">
                <div class="card-header bg-primary text-white rounded-top-4">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-journal-bookmark-fill me-2"></i>
                        <h5 class="mb-0">Select Course</h5>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="mb-3">
                        <label for="course" style="color: gray;" class="form-label fw-semibold">
                            <i class="bi bi-book me-2 text-primary"></i>Choose Course
                        </label>
                        <select id="course" name="course" class="form-select form-select-lg border-primary" 
                                required onchange="filterCOsByCourse(); updateMappingFields();">
                            <option value="">Select a course...</option>
                            {% for course in courses %}
                                <option value="{{ course.id }}">{{ course.code }} - {{ course.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="alert alert-info" role="alert" id="courseAlert" style="display: none;">
                        <i class="bi bi-info-circle me-2"></i>
                        <span>Please select a course to enable mapping options</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual and Bulk Entries in Row -->
    <div class="row">
        <!-- Manual Mapping Card -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-lg rounded-4" data-aos="fade-right">
                <div class="card-header bg-gradient-primary text-white rounded-top-4">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-pencil-square me-2"></i>
                        <h5 class="mb-0">Manual Mapping</h5>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form method="post" id="manualMappingForm">
                        {% csrf_token %}
                        <input type="hidden" name="course" id="hidden_course" value="">
                        
                        <div class="mb-4">
                            <label style="color: gray;"  for="co" class="form-label fw-semibold">
                                <i class="bi bi-target me-2 text-primary"></i>Course Outcome (CO)
                            </label>
                            <select id="co" name="co" class="form-select form-select-lg border-primary" required disabled>
                                <option value="">Select a CO...</option>
                                {% for co in cos %}
                                    <option value="{{ co.id }}" data-course="{{ co.course.id }}">
                                        CO{{ co.number }} - {{ co.description|truncatechars:50 }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-4">
                            <label style="color: gray;"  for="po" class="form-label fw-semibold">
                                <i class="bi bi-bullseye me-2 text-success"></i>Program Outcome (PO)
                            </label>
                            <select id="po" name="po" class="form-select form-select-lg border-success" required disabled>
                                <option value="">Select a PO...</option>
                                {% for po in pos %}
                                    <option value="{{ po.id }}">
                                        PO{{ po.number }} - {{ po.description|truncatechars:50 }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-4">
                            <label style="color: gray;"  for="level" class="form-label fw-semibold">
                                <i class="bi bi-speedometer2 me-2 text-warning"></i>Mapping Level
                            </label>
                            <select name="level" id="level" class="form-select form-select-lg border-warning" required disabled>
                                <option value="">Select level...</option>
                                <option value="1" class="text-danger">ðŸ”´ Low (1)</option>
                                <option value="2" class="text-warning">ðŸŸ¡ Medium (2)</option>
                                <option value="3" class="text-success">ðŸŸ¢ High (3)</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg w-100" id="submitBtn" disabled>
                            <i class="bi bi-plus-circle me-2"></i>Create Mapping
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Bulk Upload Card -->
        <div class="col-lg-6 mb-4">
            <div class="card border-0 shadow-lg rounded-4" data-aos="fade-left">
                <div class="card-header bg-gradient-success text-white rounded-top-4">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-cloud-upload-fill me-2"></i>
                        <h5 class="mb-0">Bulk Upload</h5>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" id="bulkUploadForm">
                        {% csrf_token %}
                        <input type="hidden" name="course" id="hidden_course_excel" value="">
                        
                        <div class="mb-4">
                            <label style="color: gray;"  for="excel_file" class="form-label fw-semibold">
                                <i class="bi bi-file-earmark-excel me-2 text-success"></i>Upload Excel File
                            </label>
                            <div class="input-group">
                                <input type="file" name="excel_file" id="excel_file" 
                                       class="form-control form-control-lg border-success" 
                                       accept=".xlsx,.xls" required>
                                <button class="btn btn-outline-success" type="button" id="fileHelpBtn">
                                    <i class="bi bi-question-circle"></i>
                                </button>
                            </div>
                            <small style="color: gray;"  >
                                <i class="bi bi-info-circle me-1"></i>
                                Format: CO_ID, PO_ID, LEVEL (with headers in first row)
                            </small>
                        </div>

                        <div class="alert alert-warning" role="alert" id="uploadAlert" style="display: none;">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span>Please select a course before uploading</span>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg w-100" id="uploadBtn" disabled>
                            <i class="bi bi-upload me-2"></i>Upload & Process
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Card - Centered below -->
    <div class="row justify-content-center mt-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-lg rounded-4" data-aos="zoom-in">
                <div class="card-header bg-gradient-info text-white rounded-top-4">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-bar-chart-fill me-2"></i>
                        <h5 class="mb-0">Quick Stats</h5>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="stat-item">
                                <h3 class="text-primary mb-1" id="totalCOs">0</h3>
                                <small style="color: gray;"  >Total COs</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item">
                                <h3 class="text-success mb-1" id="totalPOs">0</h3>
                                <small style="color: gray;"  >Total POs</small>
                            </div>
                        </div>
                    </div>
                    <div class="progress mt-3" style="height: 8px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" id="mappingProgress"></div>
                    </div>
                    <small style="color: gray;"  class=" mt-2 d-block text-center">
                        <span  id="mappingCount">0</span> mappings created
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<button class="btn btn-primary btn-lg rounded-circle position-fixed" 
        style="bottom: 30px; right: 30px; width: 60px; height: 60px; z-index: 1000;"
        data-bs-toggle="tooltip" data-bs-placement="left" title="Need Help?"
        data-aos="zoom-in" data-aos-delay="500">
    <i class="bi bi-question-lg"></i>
</button>

<style>
    .hero-section {
        background: linear-gradient(135deg, #43cea2 0%, #185a9d 100%);
        color: rgb(6, 5, 5);
        border-radius: 0 0 50px 50px;
    }
    
    .card {
        transition: all 0.3s ease;
        border: none !important;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
    }
    
    .form-select:focus, .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .bg-gradient-success {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    }
    
    .bg-gradient-info {
        background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
    }
    
    .stat-item {
        padding: 1rem;
        border-radius: 10px;
        background: #f8f9fa;
        transition: all 0.3s ease;
    }
    
    .stat-item:hover {
        background: #e9ecef;
        transform: scale(1.05);
    }
    
    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
    }
    
    .rounded-4 {
        border-radius: 1rem !important;
    }
    
    .rounded-top-4 {
        border-top-left-radius: 1rem !important;
        border-top-right-radius: 1rem !important;
    }
</style>

<script>
// Enhanced JavaScript with animations and better UX
function filterCOsByCourse() {
    const courseId = document.getElementById('course').value;
    const coSelect = document.getElementById('co');
    const courseAlert = document.getElementById('courseAlert');
    const uploadAlert = document.getElementById('uploadAlert');
    
    // Filter COs based on selected course
    let visibleCOs = 0;
    for (let i = 0; i < coSelect.options.length; i++) {
        const option = coSelect.options[i];
        if (!option.value) continue;
        
        if (option.getAttribute('data-course') === courseId) {
            option.style.display = '';
            visibleCOs++;
        } else {
            option.style.display = 'none';
        }
    }
    
    // Update hidden course fields
    document.getElementById('hidden_course').value = courseId;
    document.getElementById('hidden_course_excel').value = courseId;
    
    // Show/hide alerts and enable/disable buttons
    const courseSelected = courseId !== '';
    courseAlert.style.display = courseSelected ? 'none' : 'block';
    uploadAlert.style.display = courseSelected ? 'none' : 'block';
    
    // Enable/disable form elements
    document.getElementById('co').disabled = !courseSelected;
    document.getElementById('po').disabled = !courseSelected;
    document.getElementById('level').disabled = !courseSelected;
    document.getElementById('submitBtn').disabled = !courseSelected;
    document.getElementById('uploadBtn').disabled = !courseSelected;
    
    // Reset selections
    coSelect.value = '';
    
    // Update stats
    updateStats(visibleCOs);
}

function updateMappingFields() {
    const courseSelected = document.getElementById('course').value !== '';
    
    // Enable/disable form elements with smooth transitions
    const elements = ['co', 'po', 'level', 'submitBtn', 'uploadBtn'];
    elements.forEach(id => {
        const element = document.getElementById(id);
        element.disabled = !courseSelected;
        element.style.opacity = courseSelected ? '1' : '0.6';
    });
}

function updateStats(visibleCOs) {
    document.getElementById('totalCOs').textContent = visibleCOs;
    document.getElementById('totalPOs').textContent = document.getElementById('po').options.length - 1;
    
    // Simulate progress (in real app, this would come from server)
    const progress = Math.min(visibleCOs * 10, 100);
    document.getElementById('mappingProgress').style.width = progress + '%';
    document.getElementById('mappingCount').textContent = Math.floor(progress / 10);
}

// Form submission animations
document.getElementById('manualMappingForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
    submitBtn.disabled = true;
});

document.getElementById('bulkUploadForm').addEventListener('submit', function(e) {
    const uploadBtn = document.getElementById('uploadBtn');
    uploadBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Uploading...';
    uploadBtn.disabled = true;
});

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    updateMappingFields();
    
    // Set initial values
    const courseId = document.getElementById('course').value;
    document.getElementById('hidden_course').value = courseId;
    document.getElementById('hidden_course_excel').value = courseId;
    
    // Initialize stats
    updateStats(0);
});

// File input styling
document.getElementById('excel_file').addEventListener('change', function(e) {
    const fileName = e.target.files[0]?.name || 'No file selected';
    const label = e.target.nextElementSibling;
    label.textContent = fileName;
});
</script>
{% endblock %}
